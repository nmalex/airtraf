<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>MQTT WebSocket Test</title>
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
        <style>
            body { font-family: sans-serif; padding: 20px; }
            #log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
            input { width: 100%; margin-bottom: 8px; }
        </style>
    </head>
    <body>
        <h2>MQTT WebSocket Test</h2>
        <label>Broker WebSocket URL:</label>
        <input id="brokerUrl" value="ws://localhost:9001" />
        <label>Message to send:</label>
        <input id="message" value="Hello from browser!" />
        <button onclick="connect()">Connect</button>
        <button onclick="sendMessage()">Send to 'test/topic'</button>
        <button onclick="disconnect()">Disconnect</button>
        <!-- <h3>Log:</h3> -->
        <!-- <div id="log"></div> -->
        <!-- <h2>Image Preview:</h2> -->
        <img id="jpegPreview" />
        
        <script>
            // CRC32 lookup table generator (once)
            const CRC32_TABLE = (() => {
            	const table = new Uint32Array(256);
            	for (let i = 0; i < 256; i++) {
            		let c = i;
            		for (let j = 0; j < 8; j++) {
            			c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
            		}
            		table[i] = c >>> 0;
            	}
            	return table;
            })();

            // Function to compute CRC32 of Uint8Array
            function crc32(uint8Array) {
            	let crc = 0xFFFFFFFF;
            	for (let i = 0; i < uint8Array.length; i++) {
            		const byte = uint8Array[i];
            		crc = CRC32_TABLE[(crc ^ byte) & 0xFF] ^ (crc >>> 8);
            	}
            	return (crc ^ 0xFFFFFFFF) >>> 0; // Convert to unsigned
            }

            // Example usage
            // const data = new Uint8Array([0x01, 0x02, 0x03, 0x04]);
            // const checksum = crc32(data);
            // console.log("CRC32 (unsigned):", checksum);
            // console.log("CRC32 (hex):", checksum.toString(16).padStart(8, '0'));

            let client = null;

            const topicJpeg = "test/livemap/jpeg";
            const topicChecksum = "test/livemap/jpeg/crc32";

            function log(message) {
            	//const logDiv = document.getElementById("log");
            	//logDiv.innerHTML += message + "<br>";
            	//logDiv.scrollTop = logDiv.scrollHeight;
            	console.log(message);
            }

            function showJPEGFromBytes(byteArray) {
            	const blob = new Blob([byteArray], {
            		type: 'image/jpeg'
            	});
            	const url = URL.createObjectURL(blob);
            	document.getElementById('jpegPreview').src = url;
            }

            function connect() {
            	const url = document.getElementById("brokerUrl").value;
            	log("Connecting to " + url);

            	client = mqtt.connect(url);

            	client.on("connect", () => {
            		log("Connected");

            		client.subscribe(topicChecksum, err => {
            			if (err) {
            				log("Subscribe error: " + err.message);
            			} else {
            				log("Subscribed to '" + topicChecksum + "'");
            			}
            		});

            		client.subscribe(topicJpeg, err => {
            			if (err) {
            				log("Subscribe error: " + err.message);
            			} else {
            				log("Subscribed to '" + topicJpeg + "'");
            			}
            		});

            	});

            	client.on("message", (recvTopic, payload) => {
            		log("Message on '" + recvTopic);
            		if (recvTopic == topicChecksum) {
            			const json = JSON.parse(payload.toString());
                  window.__nextJpegChecksum = json.crc32;
            			//console.log(json);
            		} else {
                  const checksum = crc32(payload);
                  //console.log("CRC32 (unsigned): actual, expected: ", checksum, window.__nextJpegChecksum);

            			//console.log(payload);

                  showJPEGFromBytes(payload);
            		}
            		
            	});

            	client.on("error", (err) => {
            		log("Error: " + err.message);
            	});

            	client.on("close", () => {
            		log("Disconnected");
            	});
            }

            function sendMessage() {
            	if (!client || !client.connected) {
            		log("Not connected.");
            		return;
            	}

            	const message = document.getElementById("message").value;
            	client.publish(topic, message);
            	log("Sent: " + message);
            }

            function disconnect() {
            	if (client) {
            		client.end();
            		log("Disconnecting...");
            	}
            }
        </script>
    </body>
</html>